<div class="container-fluid content-container pr-0 pl-0">
  <div class="container-fluid" *ngIf="isLoadingReviews">
    <div class="row" style="height: 50vh">
      <div class="col-12 d-flex justify-content-center">
        <span class="text-header my-auto mr-5">Ładuję recenzje...</span>
        <mat-progress-spinner class="my-auto" mode="indeterminate" diameter="60"></mat-progress-spinner>
      </div>
    </div>
  </div>
  <div class="row m-0">
    <div class="col-12 p-0 reviews-container">
      <div *ngIf="loadedReviews">
        <table mat-table [dataSource]="loadedReviews" multiTemplateDataRows class="mat-elevation-z1">
          <ng-container matColumnDef="{{column}}" *ngFor="let column of reviewsTableHeaders; let i = index">
            <th mat-header-cell class="text-center" *matHeaderCellDef> {{column}} </th>
            <td mat-cell class="text-medium pl-2 pr-2 text-center" *matCellDef="let element" [ngSwitch]="column">
              <div *ngSwitchCase="reviewsTableHeaders[0]">
                <mat-chip-list>
                  <mat-chip class="pointer-events-disabled p-2" [ngStyle]="parseService.parseHistoryAndReviewStatusChipDisplayStyle(element[reviewObjectFields[i]])">
                    <span class="text-medium text-uppercase chip-text">{{parseService.parseStatus(element[reviewObjectFields[i]]) | translate}}</span>
                  </mat-chip>
                </mat-chip-list>
              </div>
              <div *ngSwitchCase="reviewsTableHeaders[1]">
                <span>{{element[reviewObjectFields[i]]}}</span>
              </div>
              <div *ngSwitchCase="reviewsTableHeaders[2]">
                <a class="text-medium text-uppercase mr-2" style="cursor: pointer">Kliknij aby odczytać</a>
              </div>
              <div *ngSwitchCase="reviewsTableHeaders[3]">
                <span>{{parseService.parseTimestampToDate(element[reviewObjectFields[i]])}}</span>
              </div>
            </td>
          </ng-container>

          <!-- Expanded Content Column - The detail row is made up of this one column that spans across all columns -->
          <ng-container matColumnDef="expandedDetail">
            <td mat-cell *matCellDef="let element" [attr.colspan]="reviewsTableHeaders.length">
              <div class="element-detail" [@detailExpand]="element == expandedReview ? 'expanded' : 'collapsed'">
                <div class="text-medium text-center p-3">
                  {{element.reviewerMessage}}
                </div>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="reviewsTableHeaders; sticky: true"></tr>
          <tr mat-row *matRowDef="let element; columns: reviewsTableHeaders;"
              class="element-row"
              [class.example-expanded-row]="expandedReview === element"
              (click)="expandedReview = expandedReview === element ? null : element">
          </tr>
          <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="detail-row"></tr>
        </table>
      </div>
    </div>
  </div>
  <div id="review-creator" class="row text-large p-2" [ngClass]="{'folded': isReviewCreatorFolded, 'disabled': !isAssignedReviewer}">
    <div class="row m-0 w-100">
      <div class="col-12 d-flex justify-content-between review-creator-toggle-button p-2 " (click)="toggleReviewCreator()">
        <span style="color: var(--white)">Dodaj recenzję</span>
        <svg-icon src="../../assets/img/svg/arrow_down.svg" class="review-creator-toggle-icon my-auto mr-2" [svgStyle]="{'width.px': '20', 'height.px': '20'}"></svg-icon>
      </div>
    </div>
    <div class="row m-0 w-100">
      <div class="col-12 m-0 p-0">
        <form [formGroup]="reviewForm" class="row review-creator-form w-100">
          <div class="col-sm-7 col-12 text-medium">
            <mat-form-field appearance="outline" class="w-100" >
              <textarea matInput formControlName="reviewMessage" #reviewComment maxlength="400" style="max-height: 100px" required ></textarea>
              <mat-hint style="color: var(--white)" align="start">Komentarz do recenzji</mat-hint>
              <mat-hint style="color: var(--white)" align="end">{{reviewComment.value.length}} / 400</mat-hint>
            </mat-form-field>
          </div>
          <div class="col-sm-5 pr-0 text-medium">
            <div class="row m-0 w-100">
              <div class="col-8 p-0">
                <mat-form-field class="w-100" appearance="outline">
                  <mat-select formControlName="reviewStatus" required>
                    <mat-option *ngFor="let statusIndex of nextStatusArray; let i = index" [value]="statusIndex">
                      {{parseService.parseStatus(statusIndex) | translate}}
                    </mat-option>
                  </mat-select>
                  <mat-hint style="color: var(--white)" align="start">Wybierz status recenzji</mat-hint>
                </mat-form-field>
                <p>
                  <mat-form-field class="w-100" appearance="outline" floatLabel="never">
                    <mat-label>
                      <div *ngIf="isLoadingReviewers" class="text-small d-flex justify-content-between">
                        <span class="my-auto">Ładuję recenzentów...</span>
                        <mat-spinner class="spinner" diameter="20"></mat-spinner>
                      </div>
                    </mat-label>
                    <mat-select formControlName="nextReviewer" [disabled]="reviewNextStatusValid.invalid && isNextReviewerRequired()" [required]="isNextReviewerRequired()">
                      <mat-select-trigger>
                          <span *ngIf="selectedReviewerName">
                            {{selectedReviewerName}}
                          </span>
                      </mat-select-trigger>
                      <mat-option class="h-100 p-3" *ngFor="let reviewer of loadedReviewers; let i = index" [value]="loadedReviewers[i]">
                      <span class="text-medium mb-1">
                        <strong>{{ reviewer.reviewerName}} </strong>
                      </span>
                        <br>
                        <span>
                        <mat-chip-list class="d-inline-flex">
                          <mat-chip *ngIf="reviewer.reviewerRole" class="text-medium text-capitalize pointer-events-disabled" [ngStyle]="parseService.parseRoleChipDisplayStyle(reviewer.reviewerRole)">{{parseService.parseRole(reviewer.reviewerRole) | translate}}</mat-chip>
                          <mat-chip *ngIf="!reviewer.reviewerRole" class="text-medium text-capitalize pointer-events-disabled">AUTOR</mat-chip>
                          <mat-chip class="text-small" style="pointer-events: none; color: var(--white); background-color: var(--blue)" *ngFor="let area of reviewer.reviewerArea">
                            {{parseService.parseArea(area) | translate}}
                          </mat-chip>
                        </mat-chip-list>
                      </span>
                      </mat-option>
                    </mat-select>
                    <mat-hint style="color: var(--white)" align="start">Wybierz recenzenta</mat-hint>
                  </mat-form-field>
                </p>
              </div>
              <div class="col-4 m-0 my-auto text-center align-items-center">
                <button mat-fab class="send-review-button my-auto" (click)="sendReview()" [disabled]="isSendingReview">
                  <svg-icon src="../../assets/img/svg/send_review.svg" [applyClass]="false" svgClass="send-review-icon"></svg-icon>
                </button>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
